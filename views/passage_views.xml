<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Passage Form View -->
    <record id="passage_view_form" model="ir.ui.view">
        <field name="name">quiz.passage.form</field>
        <field name="model">quiz.passage</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="sequence"/>
                        <field name="name"/>
                        <field name="question_id" invisible="1"/>
                    </group>
                    <field name="passage_content" widget="html"/>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Passage Tree View -->
    <record id="passage_view_tree" model="ir.ui.view">
        <field name="name">quiz.passage.tree</field>
        <field name="model">quiz.passage</field>
        <field name="arch" type="xml">
            <tree editable="bottom">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
            </tree>
        </field>
    </record>
    
    <!-- Sub Question Form View -->
    <record id="passage_sub_question_view_form" model="ir.ui.view">
        <field name="name">quiz.passage.sub.question.form</field>
        <field name="model">quiz.passage.sub.question</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="sequence"/>
                        <field name="question_type"/>
                        <field name="points"/>
                    </group>
                    <field name="question_text" widget="html"/>
                    <notebook>
                        <page string="Answer" invisible="question_type not in ['text_short', 'text_long']">
                            <group>
                                <field name="correct_answer" placeholder="For text answers, enter keywords separated by commas" 
                                       required="question_type in ['text_short', 'text_long']"/>
                            </group>
                        </page>
                        <page string="Choices" invisible="question_type not in ['mcq_single', 'mcq_multiple']">
                            <field name="choice_ids" context="{'default_sub_question_id': active_id}"
                                   required="question_type in ['mcq_single', 'mcq_multiple']">
                                <tree editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="text"/>
                                    <field name="is_correct"/>
                                    <field name="sub_question_id" invisible="1"/>
                                </tree>
                                <form>
                                    <group>
                                        <field name="text"/>
                                        <field name="is_correct"/>
                                        <field name="sub_question_id" invisible="1"/>
                                    </group>
                                </form>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Sub Question Tree View -->
    <record id="passage_sub_question_view_tree" model="ir.ui.view">
        <field name="name">quiz.passage.sub.question.tree</field>
        <field name="model">quiz.passage.sub.question</field>
        <field name="arch" type="xml">
            <tree>
                <field name="sequence" widget="handle"/>
                <field name="question_type"/>
                <field name="points"/>
            </tree>
        </field>
    </record>

    <!-- Include Passage fields in Question Form -->
    <record id="view_question_form_with_passage" model="ir.ui.view">
        <field name="name">quiz.question.form.passage</field>
        <field name="model">quiz.question</field>
        <field name="inherit_id" ref="quiz_engine_pro.view_quiz_question_form"/>
        <field name="arch" type="xml">
            <notebook position="inside">
                <page string="Reading Passage" invisible="type != 'passage'">
                    <div class="row">
                        <div class="col-12">
                            <h3>Passage Content</h3>
                            <field name="passage_ids" context="{'default_question_id': active_id}">
                                <tree>
                                    <field name="sequence" widget="handle"/>
                                    <field name="name"/>
                                </tree>
                                <form>
                                    <sheet>
                                        <group>
                                            <field name="name"/>
                                            <field name="passage_content" widget="html"/>
                                        </group>
                                        <notebook>
                                            <page string="Sub-Questions">
                                                <field name="sub_question_ids">
                                                    <tree>
                                                        <field name="sequence" widget="handle"/>
                                                        <field name="question_text"/>
                                                        <field name="question_type"/>
                                                        <field name="points"/>
                                                    </tree>
                                                </field>
                                            </page>
                                        </notebook>
                                    </sheet>
                                </form>
                            </field>
                            <div class="alert alert-info mt-3" role="alert">
                                <p><i class="fa fa-info-circle" title="Passage info"></i> Create one or more reading passages that students will refer to when answering the questions.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h3>Sub-questions</h3>
                        <p class="text-muted">Add questions related to the passage.</p>
                        
                        <!-- We'll use a widget to show sub-questions. This requires selecting a passage first -->
                        <div invisible="passage_ids == False or passage_ids == []">
                            <field name="active_passage_id" invisible="1"/>
                            <field name="sub_question_ids" widget="one2many" context="{'default_passage_id': active_passage_id}">
                                <tree>
                                    <field name="sequence" widget="handle"/>
                                    <field name="question_text" widget="html"/>
                                    <field name="question_type"/>
                                    <field name="points"/>
                                </tree>
                                <form>
                                    <sheet>
                                        <group>
                                            <field name="question_text" widget="html"/>
                                            <field name="question_type"/>
                                            <field name="points"/>
                                        </group>
                                        <notebook>
                                            <page string="Answer" invisible="question_type not in ['text_short', 'text_long']">
                                                <group>
                                                    <field name="correct_answer" required="question_type in ['text_short', 'text_long']"/>
                                                </group>
                                            </page>
                                            <page string="Choices" invisible="question_type not in ['mcq_single', 'mcq_multiple']">
                                                <field name="choice_ids" required="question_type in ['mcq_single', 'mcq_multiple']">
                                                    <tree editable="bottom">
                                                        <field name="sequence" widget="handle"/>
                                                        <field name="text"/>
                                                        <field name="is_correct"/>
                                                    </tree>
                                                    <form>
                                                        <group>
                                                            <field name="text"/>
                                                            <field name="is_correct"/>
                                                        </group>
                                                    </form>
                                                </field>
                                            </page>
                                        </notebook>
                                    </sheet>
                                </form>
                            </field>
                        </div>
                        
                        <div class="alert alert-warning mt-3" invisible="passage_ids != False and passage_ids != []" role="alert">
                            <p><i class="fa fa-exclamation-triangle" title="Warning"></i> Please create at least one passage above first.</p>
                        </div>
                    </div>
                </page>
            </notebook>
        </field>
    </record>
</odoo>
